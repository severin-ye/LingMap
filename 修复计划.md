# 《凡人修仙传》因果事件图谱生成系统 - 问题修复与改进方案

## 一、问题诊断与分析

### 1.1 当前问题概述

根据系统运行结果分析，目前存在以下关键问题：

1. **事件抽取模块失效**：系统无法从文本中提取事件，导致事件JSON为空数组
2. **路径解析错误**：`path_utils.py`中的路径计算可能存在问题
3. **配置文件路径错误**：从错误日志看到 `/common/common/config/` 这种双重路径
4. **API调用问题**：LLM API调用可能失败，没有返回预期响应
5. **空图谱输出**：由于没有事件，最终生成的Mermaid图谱只包含图例

### 1.2 可能的原因分析

1. **路径问题**：
   - 不同模块使用不同的方式计算项目根路径
   - `path_utils.py`中PROJECT_ROOT计算可能错误
   - 配置文件路径拼接不正确

2. **API调用问题**：
   - API密钥配置不正确或缺失
   - API请求参数格式错误
   - API调用超时或错误没有被正确处理

3. **数据流问题**：
   - 模块间数据传递格式不一致
   - 模块内部处理逻辑错误

## 二、修复策略与路径

### 2.1 分步修复计划

#### 步骤1：修复路径计算问题
- 统一路径计算方式，确保`path_utils.py`能正确计算项目根目录
- 测试各主要模块的路径解析逻辑

#### 步骤2：验证配置文件
- 检查提示词模板文件的内容和格式是否正确
- 确保配置文件能够被正确加载

#### 步骤3：LLM API调用调试
- 添加详细日志记录API请求和响应
- 实现更完善的错误处理
- 测试API连接性

#### 步骤4：事件抽取模块修复
- 修复`extractor_service.py`中的问题
- 增强对不同文本格式的处理能力

#### 步骤5：端到端测试
- 使用测试小说片段验证完整流程
- 确保每个环节数据流转正确

### 2.2 验证方法

对于每个修复步骤，采用以下验证方法：

1. **日志验证**：增加详细日志，跟踪数据流和处理过程
2. **断点检查**：在关键节点输出中间结果
3. **单元测试**：针对修复的模块编写单元测试
4. **集成测试**：测试模块间的交互

## 三、具体实施计划

### 3.1 修复路径计算

1. 检查并修正`path_utils.py`中的PROJECT_ROOT计算
2. 在所有模块中统一使用`path_utils`获取路径
3. 添加路径验证打印，确保计算结果正确

### 3.2 增强日志系统

1. 配置结构化日志记录
2. 在关键处理环节添加详细日志
3. 添加API调用跟踪日志

### 3.3 调试API调用

1. 实现API调用测试功能
2. 增加API响应验证
3. 完善错误处理和重试机制

### 3.4 修复事件抽取模块

1. 检查提示词模板配置
2. 验证LLM响应解析逻辑
3. 调整事件提取算法

### 3.5 完善错误处理

1. 捕获并记录所有可能的异常
2. 实现优雅的降级策略
3. 提供用户友好的错误提示

## 四、具体任务与步骤

### 任务1：修复路径计算问题
- [ ] 1.1 验证`path_utils.py`中的PROJECT_ROOT计算
- [ ] 1.2 添加测试代码验证路径是否正确
- [ ] 1.3 统一各模块的路径获取方式

### 任务2：配置文件验证
- [ ] 2.1 验证提示词模板文件内容
- [ ] 2.2 测试配置文件加载
- [ ] 2.3 规范化配置文件路径

### 任务3：增强调试能力
- [ ] 3.1 完善日志系统
- [ ] 3.2 添加调试模式
- [ ] 3.3 实现API调用测试

### 任务4：事件抽取模块修复
- [ ] 4.1 调试事件抽取模块
- [ ] 4.2 检查LLM响应处理逻辑
- [ ] 4.3 优化事件提取算法

### 任务5：端到端测试
- [ ] 5.1 创建简单测试样例
- [ ] 5.2 运行完整流程测试
- [ ] 5.3 验证输出结果

## 五、项目改进计划

### 5.1 短期改进

1. **容错性增强**：
   - 添加更多的异常处理
   - 实现降级策略，确保部分失败不影响整体流程

2. **可调试性提升**：
   - 增加调试模式
   - 添加详细日志
   - 提供中间结果保存功能

3. **文档完善**：
   - 更新API使用文档
   - 添加故障排除指南

### 5.2 中长期改进

1. **系统架构优化**：
   - 重构模块间通信方式
   - 实现更好的依赖注入机制

2. **功能增强**：
   - 改进事件抽取精确度
   - 增强因果关系推理能力
   - 添加更多图谱可视化选项

3. **测试覆盖率提升**：
   - 增加单元测试覆盖率
   - 添加端到端测试用例
   - 实现自动化测试流程
