æ ¹æ®ä½ çš„åå¥½ï¼Œæˆ‘ä¸ºã€Šå‡¡äººä¿®ä»™ä¼ å› æœå›¾è°±ç³»ç»Ÿã€‹åŸºäºR2æ¡†æ¶è®¾è®¡äº†**è¯¦ç»†çš„å¾®æœåŠ¡ä»£ç ç»“æ„ä¸æ¨¡å—å®ç°æ¡†æ¶**ï¼Œæ»¡è¶³ä»¥ä¸‹ç‰¹æ€§ï¼š

* å¾®æœåŠ¡æ¶æ„ï¼ˆæ¯ä¸ªåŠŸèƒ½åŸŸç‹¬ç«‹æœåŠ¡ï¼‰
* æ¯ä¸ªæœåŠ¡å†…éƒ¨é‡‡ç”¨â€œæ¨¡å—åˆ’åˆ† + åˆ†å±‚è®¾è®¡â€
* ä½¿ç”¨ä¾èµ–æ³¨å…¥ + æŠ½è±¡åŸºç±»å®šä¹‰æ¸…æ™°æ¥å£
* JSON é…ç½® + ThreadPoolExecutor å¼‚æ­¥å¤„ç†
* å¯æ’æ‹”çš„Annoyå‘é‡æ£€ç´¢

---

# ğŸ—ï¸ é¡¶å±‚ç›®å½•ç»“æ„ï¼ˆé¡¹ç›®æ ¹ç›®å½•ï¼‰

```
r2-fanren/                      # é¡¹ç›®æ ¹ç›®å½•
â”œâ”€â”€ services/                   # å¾®æœåŠ¡é›†åˆç›®å½•
â”‚   â”œâ”€â”€ text_ingestion/         # æ–‡æœ¬æ‘„å…¥æœåŠ¡ï¼šå°†TXTè½¬æ¢ä¸ºæ ‡å‡†åŒ–ç« èŠ‚JSON
â”‚   â”œâ”€â”€ event_extraction/       # äº‹ä»¶æŠ½å–æœåŠ¡ï¼šæå–å…³é”®äº‹ä»¶ã€äººç‰©ã€å®ç‰©ç­‰
â”‚   â”œâ”€â”€ hallucination_refine/   # å¹»è§‰ä¿®æ­£æœåŠ¡ï¼šä½¿ç”¨HARç²¾ä¿®LLMè¾“å‡º
â”‚   â”œâ”€â”€ causal_linking/         # å› æœå…³è”æœåŠ¡ï¼šåˆ†æäº‹ä»¶é—´å› æœå…³ç³»
â”‚   â”œâ”€â”€ graph_builder/          # å›¾è°±æ„å»ºæœåŠ¡ï¼šç”Ÿæˆå¯è§†åŒ–å›¾è°±ä»£ç 
â”‚   â””â”€â”€ api_gateway/            # APIç½‘å…³æœåŠ¡ï¼šç»Ÿä¸€æ¥å£å…¥å£
â”œâ”€â”€ common/                     # å…±äº«ç»„ä»¶ç›®å½•
â”‚   â”œâ”€â”€ models/                 # é¢†åŸŸæ¨¡å‹å®šä¹‰ï¼šæ ¸å¿ƒæ•°æ®ç»“æ„
â”‚   â”œâ”€â”€ schemas/                # æ•°æ®éªŒè¯æ¶æ„ï¼šè¯·æ±‚å’Œå“åº”éªŒè¯
â”‚   â”œâ”€â”€ interfaces/             # æŠ½è±¡æ¥å£å®šä¹‰ï¼šç»Ÿä¸€æ¥å£è§„èŒƒ
â”‚   â”œâ”€â”€ config/                 # é…ç½®ç®¡ç†ï¼šé…ç½®åŠ è½½å·¥å…·
â”‚   â””â”€â”€ utils/                  # é€šç”¨å·¥å…·å‡½æ•°ï¼šæ—¥å¿—ã€åºåˆ—åŒ–ç­‰
â”œâ”€â”€ scripts/                    # è¾…åŠ©è„šæœ¬ï¼šéƒ¨ç½²ã€æ‰“åŒ…å’Œç»´æŠ¤
â”œâ”€â”€ configs/                    # é…ç½®æ–‡ä»¶ï¼šJSONé…ç½®ã€æç¤ºæ¨¡æ¿ç­‰
â”œâ”€â”€ tests/                      # æµ‹è¯•ç›®å½•ï¼šå•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•
â””â”€â”€ README.md                   # é¡¹ç›®è¯´æ˜æ–‡æ¡£
```

---

# ğŸ§© æ¯ä¸ªå¾®æœåŠ¡ç»“æ„è§„èŒƒï¼ˆä»¥ `event_extraction` ä¸ºä¾‹ï¼‰

```
event_extraction/
â”œâ”€â”€ app.py                    # FastAPI å…¥å£æˆ– Worker è„šæœ¬
â”œâ”€â”€ controller/               # å¤–éƒ¨æ¥å£å±‚ï¼ˆAPI è°ƒç”¨ / CLI æ¥å£ï¼‰
â”‚   â””â”€â”€ extractor_controller.py
â”œâ”€â”€ service/                  # ä¸šåŠ¡é€»è¾‘å±‚
â”‚   â””â”€â”€ extractor_service.py
â”œâ”€â”€ repository/               # æ•°æ®æºæˆ–å¤–éƒ¨æ¨¡å—è®¿é—®ï¼ˆLLMè°ƒç”¨ï¼‰
â”‚   â””â”€â”€ llm_client.py
â”œâ”€â”€ domain/                   # é¢†åŸŸæ¨¡å‹ä¸æŠ½è±¡æ¥å£
â”‚   â”œâ”€â”€ base_extractor.py     # ABC æ¥å£
â”‚   â””â”€â”€ models.py             # æ•°æ®ç»“æ„
â”œâ”€â”€ di/                       # ä¾èµ–æ³¨å…¥å®¹å™¨
â”‚   â””â”€â”€ provider.py
â””â”€â”€ config.json
```

---

# ğŸ§± æ ¸å¿ƒæœåŠ¡è®¾è®¡æ¸…å•

| æœåŠ¡åç§°                   | ä¸»è¦èŒè´£             | è¾“å‡ºç±»å‹               |
| ---------------------- | ---------------- | ------------------ |
| `text_ingestion`       | åŠ è½½txtå°è¯´â†’æ ‡å‡†ç« èŠ‚JSON | `List[Chapter]`    |
| `event_extraction`     | æŠ½å–äº‹ä»¶ã€å®ç‰©ã€äººç‰©ç­‰ç»“æ„    | `List[EventItem]`  |
| `hallucination_refine` | ä½¿ç”¨HARç²¾ä¿®LLMè¾“å‡º     | `List[EventItem]`  |
| `causal_linking`       | æ„å»ºäº‹ä»¶å¯¹åŠå…¶å› æœå¼ºåº¦      | `List[CausalEdge]` |
| `graph_builder`        | æ„å»ºMermaidæ ¼å¼å›¾è°±ä»£ç   | `str`              |
| `api_gateway`          | æ•´åˆæ‰€æœ‰æœåŠ¡ä¸ºç»Ÿä¸€CLI/API | `REST / CLI`       |

---

# ğŸ“¦ æŠ½è±¡æ¥å£ï¼ˆä¸¾ä¾‹ï¼‰

`common/interfaces/extractor.py`

```python
from abc import ABC, abstractmethod
from typing import List
from common.models.event import EventItem
from common.models.chapter import Chapter

class AbstractExtractor(ABC):
    @abstractmethod
    def extract(self, chapter: Chapter) -> List[EventItem]:
        pass
```

---

# ğŸ§  æ„é€ å‡½æ•°æ³¨å…¥ + æœåŠ¡æ³¨å†Œï¼ˆä¾èµ–æ³¨å…¥ï¼‰

`event_extraction/di/provider.py`

```python
from common.interfaces.extractor import AbstractExtractor
from event_extraction.service.extractor_service import EventExtractor

def provide_extractor() -> AbstractExtractor:
    return EventExtractor(model="gpt-4o", prompt_path="configs/prompt_event.json")
```

---

# ğŸ” å¹¶å‘æ‰§è¡Œç»“æ„ï¼ˆä¾‹å¦‚äº‹ä»¶æ‰¹å¤„ç†ï¼‰

```python
from concurrent.futures import ThreadPoolExecutor
from event_extraction.service.extractor_service import EventExtractor

executor = ThreadPoolExecutor(max_workers=5)

results = list(executor.map(lambda ch: extractor.extract(ch), chapter_list))
```

---

# ğŸ§© JSON é…ç½®æ–‡ä»¶ç¤ºä¾‹ï¼ˆevent\_extraction/config.jsonï¼‰

```json
{
  "model": "gpt-4o",
  "temperature": 0.0,
  "prompt_template": "./configs/prompt_event.json",
  "max_chunk_length": 1024
}
```

---

# ğŸ§² å‘é‡ç´¢å¼•æ¨¡å—ç»“æ„ï¼ˆAnnoyï¼‰

```
common/vector_store/
â”œâ”€â”€ annoy_indexer.py
â”œâ”€â”€ encoder.py
â””â”€â”€ interface.py
```

```python
class AnnoyIndexer(AbstractIndexer):
    def build_index(self, items: List[str]) -> None:
        ...
    def query(self, query: str, top_k: int = 5) -> List[str]:
        ...
```

---

# ğŸ“ˆ GraphBuilder è¾“å‡ºæ ¼å¼ï¼ˆMermaidï¼‰

`graph_builder/service/graph_builder.py`

```python
def build_mermaid(events: List[EventItem], links: List[CausalEdge]) -> str:
    nodes = "\n".join([f'{e.event_id}[{e.description}]' for e in events])
    edges = "\n".join([f'{link.from_id} --> {link.to_id}' for link in links])
    return f"graph TD\n{nodes}\n{edges}"
```

---

# ğŸ§ª æµ‹è¯•ä¸éªŒè¯

```
tests/
â”œâ”€â”€ test_event_extraction.py
â”œâ”€â”€ test_refine_module.py
â”œâ”€â”€ test_causal_linking.py
â””â”€â”€ test_graph_output.py
```

ä½¿ç”¨ `pytest`ï¼Œé€šè¿‡ä¾èµ–æ³¨å…¥çš„ mock provider æµ‹è¯•ä¸šåŠ¡é€»è¾‘ï¼Œç¡®ä¿æœåŠ¡ç‹¬ç«‹æ€§ã€‚

---

# ğŸš€ å¯åŠ¨ä¸è°ƒç”¨

* å„æœåŠ¡å¯é€šè¿‡ `python app.py` å¯åŠ¨æœ¬åœ°å¾®æœåŠ¡/è„šæœ¬
* `api_gateway` æä¾›ç»Ÿä¸€å…¥å£æ”¯æŒ REST æ¥å£æˆ– CLI æµç¨‹ï¼š

```bash
python api_gateway/main.py --input "fanren.txt" --output "out/graph.mmd"
```

---

