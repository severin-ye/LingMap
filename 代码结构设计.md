æ ¹æ®é¡¹ç›®çš„å®é™…å®ç°ï¼Œã€Šå‡¡äººä¿®ä»™ä¼ å› æœå›¾è°±ç³»ç»Ÿã€‹åŸºäºR2æ¡†æ¶é‡‡ç”¨äº†**è¯¦ç»†çš„å¾®æœåŠ¡ä»£ç ç»“æ„ä¸æ¨¡å—å®ç°æ¡†æ¶**ï¼Œæ»¡è¶³ä»¥ä¸‹ç‰¹æ€§ï¼š

* å¾®æœåŠ¡æ¶æ„ï¼ˆæ¯ä¸ªåŠŸèƒ½åŸŸç‹¬ç«‹æœåŠ¡ï¼‰
* æ¯ä¸ªæœåŠ¡å†…éƒ¨é‡‡ç”¨"æ¨¡å—åˆ’åˆ† + åˆ†å±‚è®¾è®¡"
* ä½¿ç”¨ä¾èµ–æ³¨å…¥ + æŠ½è±¡åŸºç±»å®šä¹‰æ¸…æ™°æ¥å£
* JSON é…ç½® + çµæ´»çš„æ—¥å¿—è®°å½•ç³»ç»Ÿ
* å¤šç§é“¾æ¥å™¨å®ç°å¯åŠ¨æ€åˆ‡æ¢ï¼ˆæ ‡å‡†ã€ä¼˜åŒ–ã€ç»Ÿä¸€ç‰ˆï¼‰

---

# ğŸ—ï¸ é¡¶å±‚ç›®å½•ç»“æ„ï¼ˆé¡¹ç›®æ ¹ç›®å½•ï¼‰

```
é¡¹ç›®æ ¹ç›®å½•/                      # é¡¹ç›®æ ¹ç›®å½•
â”œâ”€â”€ api_gateway/               # APIç½‘å…³æœåŠ¡ï¼šç»Ÿä¸€æ¥å£å…¥å£
â”‚   â”œâ”€â”€ main.py                # ç½‘å…³å…¥å£ç‚¹
â”‚   â””â”€â”€ router/                # è·¯ç”±å®šä¹‰
â”œâ”€â”€ event_extraction/          # äº‹ä»¶æŠ½å–æœåŠ¡ï¼šæå–å…³é”®äº‹ä»¶ã€äººç‰©ã€å®ç‰©ç­‰
â”‚   â”œâ”€â”€ app.py                 # æœåŠ¡å…¥å£
â”‚   â”œâ”€â”€ controller/            # APIæ§åˆ¶å™¨
â”‚   â”œâ”€â”€ service/               # ä¸šåŠ¡æœåŠ¡å®ç°
â”‚   â”‚   â”œâ”€â”€ extractor_service.py       # åŸºç¡€æŠ½å–å™¨
â”‚   â”‚   â””â”€â”€ enhanced_extractor_service.py  # å¢å¼ºç‰ˆæŠ½å–å™¨
â”‚   â”œâ”€â”€ di/                    # ä¾èµ–æ³¨å…¥
â”‚   â”œâ”€â”€ domain/                # é¢†åŸŸå®šä¹‰
â”‚   â””â”€â”€ repository/            # å¤–éƒ¨è°ƒç”¨å±‚
â”œâ”€â”€ causal_linking/            # å› æœå…³è”æœåŠ¡ï¼šåˆ†æäº‹ä»¶é—´å› æœå…³ç³»
â”‚   â”œâ”€â”€ app.py                 # æœåŠ¡å…¥å£
â”‚   â”œâ”€â”€ controller/            # APIæ§åˆ¶å™¨
â”‚   â”œâ”€â”€ service/               # ä¸šåŠ¡æœåŠ¡å®ç°
â”‚   â”‚   â”œâ”€â”€ linker_service.py          # åŸºç¡€é“¾æ¥å™¨
â”‚   â”‚   â”œâ”€â”€ optimized_linker_service.py # ä¼˜åŒ–ç‰ˆé“¾æ¥å™¨
â”‚   â”‚   â””â”€â”€ unified_linker_service.py  # ç»Ÿä¸€ç‰ˆé“¾æ¥å™¨
â”‚   â”œâ”€â”€ domain/                # é¢†åŸŸå®šä¹‰
â”‚   â””â”€â”€ di/                    # ä¾èµ–æ³¨å…¥
â”œâ”€â”€ hallucination_refine/      # å¹»è§‰ä¿®æ­£æœåŠ¡ï¼šä½¿ç”¨HARç²¾ä¿®LLMè¾“å‡º
â”‚   â”œâ”€â”€ app.py                 # æœåŠ¡å…¥å£
â”‚   â”œâ”€â”€ controller/            # APIæ§åˆ¶å™¨
â”‚   â”œâ”€â”€ service/               # ä¸šåŠ¡æœåŠ¡å®ç°
â”‚   â”œâ”€â”€ domain/                # é¢†åŸŸå®šä¹‰
â”‚   â””â”€â”€ di/                    # ä¾èµ–æ³¨å…¥
â”œâ”€â”€ graph_builder/             # å›¾è°±æ„å»ºæœåŠ¡ï¼šç”Ÿæˆå¯è§†åŒ–å›¾è°±ä»£ç 
â”‚   â”œâ”€â”€ app.py                 # æœåŠ¡å…¥å£
â”‚   â”œâ”€â”€ controller/            # APIæ§åˆ¶å™¨
â”‚   â”œâ”€â”€ service/               # ä¸šåŠ¡æœåŠ¡å®ç°
â”‚   â”‚   â””â”€â”€ mermaid_renderer.py # Mermaidæ ¼å¼æ¸²æŸ“å™¨
â”‚   â”œâ”€â”€ domain/                # é¢†åŸŸå®šä¹‰
â”‚   â””â”€â”€ utils/                 # å·¥å…·ç±»
â”‚       â””â”€â”€ color_map.py       # é¢œè‰²æ˜ å°„å·¥å…·
â”œâ”€â”€ text_ingestion/            # æ–‡æœ¬æ‘„å…¥æœåŠ¡ï¼šå°†TXTè½¬æ¢ä¸ºæ ‡å‡†åŒ–ç« èŠ‚JSON
â”‚   â”œâ”€â”€ app.py                 # æœåŠ¡å…¥å£
â”‚   â””â”€â”€ chapter_loader.py      # ç« èŠ‚åŠ è½½å™¨
â”œâ”€â”€ common/                    # å…±äº«ç»„ä»¶ç›®å½•
â”‚   â”œâ”€â”€ models/                # é¢†åŸŸæ¨¡å‹å®šä¹‰ï¼šæ ¸å¿ƒæ•°æ®ç»“æ„
â”‚   â”‚   â”œâ”€â”€ causal_edge.py     # å› æœè¾¹å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ chapter.py         # ç« èŠ‚æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ event.py           # äº‹ä»¶æ¨¡å‹
â”‚   â”‚   â””â”€â”€ treasure.py        # å®ç‰©æ¨¡å‹
â”‚   â”œâ”€â”€ interfaces/            # æŠ½è±¡æ¥å£å®šä¹‰ï¼šç»Ÿä¸€æ¥å£è§„èŒƒ
â”‚   â”‚   â”œâ”€â”€ extractor.py       # æŠ½å–å™¨æ¥å£
â”‚   â”‚   â”œâ”€â”€ graph_renderer.py  # å›¾å½¢æ¸²æŸ“å™¨æ¥å£
â”‚   â”‚   â”œâ”€â”€ linker.py          # é“¾æ¥å™¨æ¥å£
â”‚   â”‚   â””â”€â”€ refiner.py         # ç²¾ä¿®å™¨æ¥å£
â”‚   â”œâ”€â”€ config/                # é…ç½®ç®¡ç†ï¼šæç¤ºè¯æ¨¡æ¿å’Œé…ç½®
â”‚   â”‚   â”œâ”€â”€ config.json        # ä¸»é…ç½®æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ prompt_causal_linking.json # å› æœé“¾æ¥æç¤ºè¯
â”‚   â”‚   â”œâ”€â”€ prompt_event_extraction.json # äº‹ä»¶æŠ½å–æç¤ºè¯
â”‚   â”‚   â””â”€â”€ prompt_hallucination_refine.json # å¹»è§‰ä¿®æ­£æç¤ºè¯
â”‚   â””â”€â”€ utils/                 # é€šç”¨å·¥å…·å‡½æ•°ï¼šæ—¥å¿—ã€åºåˆ—åŒ–ç­‰
â”‚       â”œâ”€â”€ enhanced_logger.py # å¢å¼ºæ—¥å¿—å·¥å…·
â”‚       â”œâ”€â”€ json_loader.py     # JSONå·¥å…·
â”‚       â”œâ”€â”€ path_utils.py      # è·¯å¾„å·¥å…·
â”‚       â””â”€â”€ text_splitter.py   # æ–‡æœ¬åˆ†å‰²å·¥å…·
â”œâ”€â”€ scripts/                   # è¾…åŠ©è„šæœ¬ï¼šæµ‹è¯•ã€æ€§èƒ½åŸºå‡†å’Œæ¼”ç¤º
â”‚   â”œâ”€â”€ check_env.py           # ç¯å¢ƒæ£€æŸ¥
â”‚   â”œâ”€â”€ complete_test.py       # å®Œæ•´æµç¨‹æµ‹è¯•
â”‚   â”œâ”€â”€ test_linker.py         # åˆå¹¶ç‰ˆé“¾æ¥å™¨æµ‹è¯•è„šæœ¬
â”‚   â”œâ”€â”€ test_event_extraction.py # äº‹ä»¶æŠ½å–æµ‹è¯•
â”‚   â”œâ”€â”€ run_demo.py            # è¿è¡Œæ¼”ç¤º
â”‚   â””â”€â”€ run_all_tests.py       # è¿è¡Œæ‰€æœ‰æµ‹è¯•
â”œâ”€â”€ tests/                     # æµ‹è¯•ç›®å½•ï¼šåˆ†é˜¶æ®µæµ‹è¯•ç»„ç»‡
â”‚   â”œâ”€â”€ stage_1/               # ç¬¬ä¸€é˜¶æ®µæµ‹è¯•ï¼ˆåŸºç¡€æ¨¡å‹å’Œæ¥å£ï¼‰
â”‚   â”‚   â”œâ”€â”€ test_interfaces.py # æ¥å£æµ‹è¯•
â”‚   â”‚   â””â”€â”€ test_models.py     # æ¨¡å‹æµ‹è¯•
â”‚   â”œâ”€â”€ stage_2/               # ç¬¬äºŒé˜¶æ®µæµ‹è¯•ï¼ˆåŸºæœ¬æœåŠ¡åŠŸèƒ½ï¼‰
â”‚   â””â”€â”€ stage_3/               # ç¬¬ä¸‰é˜¶æ®µæµ‹è¯•ï¼ˆé›†æˆæµ‹è¯•ï¼‰
â”œâ”€â”€ logs/                      # æ—¥å¿—ç›®å½•
â”œâ”€â”€ novel/                     # å°è¯´åŸå§‹æ–‡æœ¬ç›®å½•
â”œâ”€â”€ debug/                     # è°ƒè¯•è¾“å‡ºç›®å½•
â”œâ”€â”€ output/                    # è¾“å‡ºç»“æœç›®å½•
â”œâ”€â”€ main.py                    # ä¸»ç¨‹åºå…¥å£
â”œâ”€â”€ requirements.txt           # ä¾èµ–é¡¹
â””â”€â”€ README.md                  # é¡¹ç›®è¯´æ˜æ–‡æ¡£
```

---

# ğŸ§© æ¯ä¸ªå¾®æœåŠ¡ç»“æ„è§„èŒƒï¼ˆä»¥ `causal_linking` ä¸ºä¾‹ï¼‰

```
causal_linking/
â”œâ”€â”€ app.py                    # FastAPI å…¥å£æˆ– Worker è„šæœ¬
â”œâ”€â”€ controller/               # å¤–éƒ¨æ¥å£å±‚ï¼ˆAPI è°ƒç”¨ / CLI æ¥å£ï¼‰
â”‚   â””â”€â”€ linker_controller.py
â”œâ”€â”€ service/                  # ä¸šåŠ¡é€»è¾‘å±‚
â”‚   â”œâ”€â”€ linker_service.py            # åŸºç¡€é“¾æ¥å™¨æœåŠ¡
â”‚   â”œâ”€â”€ optimized_linker_service.py  # ä¼˜åŒ–ç‰ˆé“¾æ¥å™¨ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰
â”‚   â””â”€â”€ unified_linker_service.py    # ç»Ÿä¸€ç‰ˆé“¾æ¥å™¨ï¼ˆå…¼å®¹ä¸åŒå®ç°ï¼‰
â”œâ”€â”€ repository/               # æ•°æ®æºæˆ–å¤–éƒ¨æ¨¡å—è®¿é—®
â”œâ”€â”€ domain/                   # é¢†åŸŸæ¨¡å‹ä¸æŠ½è±¡æ¥å£
â”‚   â””â”€â”€ base_linker.py        # ABC é“¾æ¥å™¨åŸºç±»
â”œâ”€â”€ di/                       # ä¾èµ–æ³¨å…¥å®¹å™¨
â”‚   â””â”€â”€ provider.py
```

---

# ğŸ§± æ ¸å¿ƒæœåŠ¡è®¾è®¡æ¸…å•

| æœåŠ¡åç§°                   | ä¸»è¦èŒè´£             | è¾“å‡ºç±»å‹               |
| ---------------------- | ---------------- | ------------------ |
| `text_ingestion`       | åŠ è½½txtå°è¯´â†’æ ‡å‡†ç« èŠ‚JSON | `List[Chapter]`    |
| `event_extraction`     | æŠ½å–äº‹ä»¶ã€å®ç‰©ã€äººç‰©ç­‰ç»“æ„    | `List[EventItem]`  |
| `hallucination_refine` | ä½¿ç”¨HARç²¾ä¿®LLMè¾“å‡º     | `List[EventItem]`  |
| `causal_linking`       | æ„å»ºäº‹ä»¶å¯¹åŠå…¶å› æœå¼ºåº¦      | `List[CausalEdge]` |
| `graph_builder`        | æ„å»ºMermaidæ ¼å¼å›¾è°±ä»£ç   | `str`              |
| `api_gateway`          | æ•´åˆæ‰€æœ‰æœåŠ¡ä¸ºç»Ÿä¸€CLI/API | `REST / CLI`       |

---

# ğŸ“¦ æŠ½è±¡æ¥å£ä¸å®ç°ï¼ˆå› æœé“¾æ¥å™¨å®ä¾‹ï¼‰

`common/interfaces/linker.py`

```python
from abc import ABC, abstractmethod
from typing import List
from common.models.event import EventItem
from common.models.causal_edge import CausalEdge

class AbstractLinker(ABC):
    @abstractmethod
    def link_events(self, events: List[EventItem]) -> List[CausalEdge]:
        """é“¾æ¥äº‹ä»¶ï¼Œæ‰¾å‡ºå› æœå…³ç³»"""
        pass
```

`causal_linking/service/unified_linker_service.py`

```python
class UnifiedCausalLinker(AbstractLinker):
    """ç»Ÿä¸€ç‰ˆå› æœé“¾æ¥å™¨ï¼ˆæ”¯æŒä¸‰ç§é“¾æ¥ç­–ç•¥ï¼‰"""
    
    def __init__(self, api_key, model="gpt-4o", strategy="optimized"):
        self.api_key = api_key
        self.model = model
        self.strategy = strategy
        
        # æ ¹æ®ç­–ç•¥åŠ¨æ€é€‰æ‹©å®é™…é“¾æ¥å™¨
        if strategy == "optimized":
            self._linker = OptimizedCausalLinker(api_key=api_key, model=model)
        elif strategy == "weighted":
            self._linker = WeightedCausalLinker(api_key=api_key, model=model)
        else:
            self._linker = CausalLinker(api_key=api_key, model=model)
    
    def link_events(self, events: List[EventItem]) -> List[CausalEdge]:
        return self._linker.link_events(events)
```

---

# ğŸ§  ä¾èµ–æ³¨å…¥å‡çº§ï¼ˆé“¾æ¥å™¨ç­–ç•¥é€‰æ‹©ï¼‰

`causal_linking/di/provider.py`

```python
from common.interfaces.linker import AbstractLinker
from causal_linking.service.linker_service import CausalLinker
from causal_linking.service.optimized_linker_service import OptimizedCausalLinker
from causal_linking.service.unified_linker_service import UnifiedCausalLinker

def provide_linker(use_optimized=False, strategy=None) -> AbstractLinker:
    """æä¾›é“¾æ¥å™¨å®ä¾‹
    
    Args:
        use_optimized: æ˜¯å¦ä½¿ç”¨ä¼˜åŒ–ç‰ˆé“¾æ¥å™¨
        strategy: ç»Ÿä¸€ç‰ˆé“¾æ¥å™¨ç­–ç•¥ï¼ˆNoneè¡¨ç¤ºä¸ä½¿ç”¨ç»Ÿä¸€ç‰ˆï¼‰
    """
    api_key = os.environ.get("LLM_API_KEY")
    model = os.environ.get("LLM_MODEL", "gpt-4o")
    
    if strategy:
        # ä½¿ç”¨ç»Ÿä¸€ç‰ˆé“¾æ¥å™¨
        return UnifiedCausalLinker(api_key=api_key, model=model, strategy=strategy)
    elif use_optimized:
        # ä½¿ç”¨ä¼˜åŒ–ç‰ˆé“¾æ¥å™¨
        return OptimizedCausalLinker(api_key=api_key, model=model)
    else:
        # ä½¿ç”¨åŸºç¡€ç‰ˆé“¾æ¥å™¨
        return CausalLinker(api_key=api_key, model=model)
```

---

# ğŸ“ˆ æµ‹è¯•æ¡†æ¶ä¸é›†æˆæµ‹è¯•

`scripts/test_linker.py` åˆå¹¶äº†ä¸‰ä¸ªé“¾æ¥å™¨ç›¸å…³çš„æµ‹è¯•è„šæœ¬ï¼š
- `test_optimized_linker.py` - ä¼˜åŒ–ç‰ˆé“¾æ¥å™¨æ€§èƒ½æµ‹è¯•
- `test_entity_weights.py` - å®ä½“é¢‘ç‡æƒé‡æµ‹è¯•
- `test_unified_linker.py` - ç»Ÿä¸€ç‰ˆé“¾æ¥å™¨å…¼å®¹æ€§æµ‹è¯•

```python
def main():
    """ä¸»å‡½æ•°ï¼šé€‰æ‹©æµ‹è¯•é¡¹ç›®"""
    parser = argparse.ArgumentParser(description="å› æœé“¾æ¥å™¨æµ‹è¯•å·¥å…·")
    
    parser.add_argument(
        "--test", 
        choices=["optimized", "entity_weights", "unified", "all"],
        default="all",
        help="è¦è¿è¡Œçš„æµ‹è¯•ç±»å‹"
    )
    
    args = parser.parse_args()
    
    if args.test in ["optimized", "all"]:
        test_optimized_vs_original()
        
    if args.test in ["entity_weights", "all"]:
        test_entity_frequency_weights()
        
    if args.test in ["unified", "all"]:
        test_unified_linker_compatibility()

if __name__ == "__main__":
    main()
```

æµ‹è¯•æ¡†æ¶é‡‡ç”¨åˆ†é˜¶æ®µç­–ç•¥ï¼Œä»åŸºç¡€ç»„ä»¶åˆ°å®Œæ•´é›†æˆï¼š
- `tests/stage_1/`: åŸºç¡€æ¨¡å‹ä¸æ¥å£æµ‹è¯•
- `tests/stage_2/`: å•ä¸ªæœåŠ¡åŠŸèƒ½æµ‹è¯•
- `tests/stage_3/`: å¤šæœåŠ¡é›†æˆæµ‹è¯•

---

# ğŸš€ å¯åŠ¨ä¸è°ƒç”¨

* å„æœåŠ¡å¯é€šè¿‡ `python app.py` å¯åŠ¨ä¸ºç‹¬ç«‹å¾®æœåŠ¡
* `main.py` æä¾›å®Œæ•´æµç¨‹çš„ä¸²è¡Œè°ƒç”¨å…¥å£
* `scripts/run_demo.py` æä¾›æ¼”ç¤ºç”¨ä¾‹è¿è¡Œå·¥å…·

```bash
# è¿è¡Œå®Œæ•´æ¼”ç¤º
python scripts/run_demo.py --input "novel/test.txt" --output "output/graph.mmd"

# ä»…æµ‹è¯•é“¾æ¥å™¨æ€§èƒ½
python scripts/test_linker.py --test optimized
```

---
